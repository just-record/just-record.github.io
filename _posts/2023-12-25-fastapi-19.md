---
layout: single
title: "FastAPI - 19 (DB - PostgresSQL)"
categories: FastAPI
tag: [FastAPI, PostgresSQL]
toc: true
toc_sticky: true
toc_label: "목차"
---
출처: [https://fastapi.tiangolo.com/ko/tutorial/sql-databases//](https://fastapi.tiangolo.com/ko/tutorial/sql-databases/)  
아래의 내용은 공식 사이트의 내용을 제 경험과 생각을 추가하여 다시 정리한 것 입니다.

## SQLAlchemy와 ORM

FastAPI와 PostgresSQL을 연동하겠습니다.  
PostgresSQL 설치는 [PostgreSQL - 01 (설치 - Windows)](/postgresql/postgresql-01/)나 [PostgreSQL - 03 (설치 - ubuntu)](/postgresql/postgresql-03/)에서 참고 하시기 바랍니다.  

FastAPI에서는 [SQLAlchemy](https://en.wikipedia.org/wiki/SQLAlchemy)를 사용하여 DB를 연동 할 수 있습니다.  

SQLAlchemy는 ORM(Object Relational Mapper)로 DB를 객체로 다룰 수 있게 해줍니다.  
SQLAlchemy는 다양한 DB를 지원합니다.  

[ORM(object-relational mapping)](https://ko.wikipedia.org/wiki/ORM)은 DB를 객체로 다루기 때문에 SQL을 사용하지 않고도 DB를 다룰 수 있습니다.

> SQLAlchemy 설치

```bash
pip install SQLAlchemy
```

> psycopg2 설치

PostgresSQL을 사용하기 위해서는 psycopg2를 설치하겠습니다.

```bash
pip install psycopg2
```

## 디렉토리 및 파일 구성

아래와 같이 디렉토리와 파일을 구성합니다.

```text
.
└── sql_app
    ├── __init__.py
    ├── crud.py
    ├── database.py
    ├── main.py
    ├── models.py
    └── schemas.py
```

root 디렉토리에 `sql_app` 디렉토리를 생성하고, `__inin__.py`를 생성합니다.  
__inin__.py는 해당 디렉토리(sql_app)가 패키지임을 알려주는 역할을 합니다.  
나머지 파일들도 생성합니다.

### database.py

`database.py`에는 DB와 연결하는 코드를 작성합니다.  

공식 사이트의 코드가 SQLAlchemy 2.0 호환 되지 않는 기능이 있어서 코드를 수정하였습니다. SQLAlchemy 2.0은 보다 명시적이고 간결한 코딩 스타일을 제공합니다. 그리고 SQLite만을 위한 코드도 제외하였습니다.

```python
# create_engine: 데이터베이스 엔진을 생성하는 함수
from sqlalchemy import create_engine
# declarative_base: ORM에서 사용되는 모델 클래스의 기본 클래스를 생성하는 함수
# sessionmaker: 데이터베이스 세션을 생성하는 데 사용되는 팩토리 함수를 임포트
from sqlalchemy.orm import declarative_base, sessionmaker

# PostgreSQL 데이터베이스에 연결하기 위한 연결 문자열
# SQLALCHEMY_DATABASE_URL = "postgresql://user:password@postgresserver/db"
# 데이터베이스: postgresql, 사용자: user01, 비밀번호: user01password, 서버: localhost, DB: mydatabase
SQLALCHEMY_DATABASE_URL = "postgresql://user01:user01@localhost/mydatabase"

# SQLAlchemy에서 데이터베이스와의 연결을 관리하는 엔진 객체를 생성
# future=True  SQLAlchemy 2.0의 새로운 스타일과 기능을 사용하도록 설정
engine = create_engine(
    SQLALCHEMY_DATABASE_URL, future=True
)


# 데이터베이스 세션 객체를 생성
# autocommit=False는 자동 커밋을 비활성화하여, 트랜잭션을 수동으로 관리
# autoflush=False는 세션에서 객체의 상태가 변경될 때 자동으로 SQL 플러시를 하지 않도록 설정
# bind=engine는 세션을 데이터베이스 엔진에 연결
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine, future=True)

# declarative_base() 함수를 호출하여, 모든 ORM 모델이 상속받을 기반 클래스(Base)를 생성
Base = declarative_base()
```

---

해시태그: #fastapi #uvicorn #OAuth2 #Bearer #JWT #인증서버 #클라이언트
